name: Deploy a Beta Release
on:
  workflow_run:
    workflows: [ Build ]
    types:
      - completed
    branches: [ beta ]
  workflow_dispatch:
    inputs:
      version:
        type: string
        description: Version to deploy
permissions:
  contents: read
jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Beta (Google Play)
    steps:
    - name: Checkout
      uses: actions/checkout@v4.1.1
      with:
        fetch-depth: 0
    - name: Download workflow artifact
      uses: dawidd6/action-download-artifact@v2
      with:
        workflow: build.yml
        branch: beta
        allow_forks: false
    - name: Copy Files
      run: |
        cp ./**/*.apk .
        cp ./**/*.aab .
        cp ./**/version .
    - name: Read Version
      id: read_version
      run: echo "version=$(cat version)" >> "$GITHUB_OUTPUT"
    - name: Upload
      uses: r0adkll/upload-google-play@v1.0.19
      with:
        serviceAccountJsonPlainText: ${{ secrets.SERVICES_ACCOUNT_JSON }}
        packageName: app.rosy_crow
        releaseFiles: app.rosy_crow-Signed.aab
        releaseName: ${{ steps.read_version.outputs.version }}
        track: beta
        status: completed
